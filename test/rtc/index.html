<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC test side</title>
    <script src="jquery-3.0.0.min.js"></script>
</head>
<body>
    <button id="connect">connect</button><br>
    <input type="text" id="message"/> <button id="send">send</button>
    <script>
        let rtcPeerConnection;
        let dataChannel;
        let button = $("#connect");
        button.on('click', () => {
            let ws = new WebSocket("ws://localhost:1111");
            ws.onopen = () => {
                console.log("WS connected");

                const config = { /*iceServers: [{ url: 'stun:stun.l.google.com:19302' }]*/ };
                rtcPeerConnection = new RTCPeerConnection(config);
                const dataChannelConfig = { ordered: false, maxRetransmits: 0 };

                rtcPeerConnection.ondatachannel = channel => {
                    console.log("Got new channel: %o", channel);
                    channel.onmessage = function(e){console.log("DC message:" +e.data);};
                    channel.onopen = function(){console.log("------ DATACHANNEL OPENED ------");};
                    channel.onclose = function(){console.log("------- DC closed! -------")};
                    channel.onerror = function(){console.log("DC ERROR!!!")};
                }
                dataChannel = rtcPeerConnection.createDataChannel('main', dataChannelConfig);
                dataChannel.onmessage = function(e){console.log("DC message:" +e.data);};
                dataChannel.onopen = function(){console.log("------ DATACHANNEL OPENED ------");};
                dataChannel.onclose = function(){console.log("------- DC closed! -------")};
                dataChannel.onerror = function(){console.log("DC ERROR!!!")};

                let sdpConstraints = {};
                sdpConstraints.offerToReceiveAudio = 0;
                sdpConstraints.offerToReceiveVideo = 0;



                ws.send(JSON.stringify({type: "hello"}));
                ws.onmessage = (message) => {
                    let data = JSON.parse(message.data);
                    if(data["type"] == "candidate") {
                        rtcPeerConnection.addIceCandidate(new RTCIceCandidate(data["msg"]));
                        console.log("Added ICE");
                    } else if(data["type"] == "answer") {
                        rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(data["msg"]));
                        console.log("Got answer!");
                    } else {
                        console.log("Invalid message type %o", data["type"]);
                    }
                };

                rtcPeerConnection.onicecandidate = (event) => {
                    console.log("Got ice candidate! Event:");
                    console.log(event);
                    if (event && event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'candidate',
                            msg: event.candidate
                        }));
                    }
                };


                rtcPeerConnection.createOffer(function (sdp) {
                    rtcPeerConnection.setLocalDescription(sdp);
                    ws.send(JSON.stringify({
                        type: "offer",
                        msg: sdp
                    }));
                    console.log("Send offer %o", sdp);
                }, () => {
                    console.error("Could not create ice offer!");
                }, sdpConstraints);
            };
        });

        $("#send").on('click', () => {
            let message = $("#message").val();
            console.log("Send message: %s", message);

            dataChannel.send(message);
        })
    </script>
</body>
</html>